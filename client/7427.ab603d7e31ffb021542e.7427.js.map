{"version":3,"file":"7427.ab603d7e31ffb021542e.7427.js","mappings":"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","sources":["webpack://semaphore/./src/routes/_actions/filters.js","webpack://semaphore/./src/routes/_api/filters.js","webpack://semaphore/./src/routes/_api/pushSubscription.js","webpack://semaphore/./src/routes/_utils/base64.js","webpack://semaphore/./src/routes/_actions/pushSubscription.js","webpack://semaphore/./src/routes/_static/instanceSettings.js"],"sourcesContent":["import { store } from '../_store/store.js'\nimport { createFilter, getFilters, updateFilter, deleteFilter as doDeleteFilter } from '../_api/filters.js'\nimport { cacheFirstUpdateAfter, cacheFirstUpdateOnlyIfNotInCache } from '../_utils/sync.js'\nimport { database } from '../_database/database.js'\nimport { isEqual } from '../_thirdparty/lodash/objects.js'\nimport { toast } from '../_components/toast/toast.js'\nimport { formatIntl } from '../_utils/formatIntl.js'\nimport { emit } from '../_utils/eventBus.js'\n\nasync function syncFilters (instanceName, syncMethod) {\n  const { loggedInInstances } = store.get()\n  const accessToken = loggedInInstances[instanceName].access_token\n\n  await syncMethod(\n    () => getFilters(instanceName, accessToken),\n    () => database.getFilters(instanceName),\n    filters => database.setFilters(instanceName, filters),\n    filters => {\n      const { instanceFilters } = store.get()\n      if (!isEqual(instanceFilters[instanceName], filters)) { // avoid re-render if nothing changed\n        instanceFilters[instanceName] = filters\n        store.set({ instanceFilters })\n      }\n    }\n  )\n}\n\nexport async function updateFiltersForInstance (instanceName) {\n  await syncFilters(instanceName, cacheFirstUpdateAfter)\n}\n\nexport async function setupFiltersForInstance (instanceName) {\n  await syncFilters(instanceName, cacheFirstUpdateOnlyIfNotInCache)\n}\n\nexport async function createOrUpdateFilter (instanceName, filter) {\n  const { loggedInInstances } = store.get()\n  const accessToken = loggedInInstances[instanceName].access_token\n  try {\n    if (filter.id) {\n      await updateFilter(instanceName, accessToken, filter)\n      /* no await */ toast.say(\"Updated filter\")\n    } else {\n      await createFilter(instanceName, accessToken, filter)\n      /* no await */ toast.say(\"Created filter\")\n    }\n    emit('wordFiltersChanged', instanceName)\n  } catch (err) {\n    /* no await */ toast.say(formatIntl([\"Failed to modify filter: \",[\"error\"]], err.message || ''))\n  }\n}\n\nexport async function deleteFilter (instanceName, id) {\n  const { loggedInInstances } = store.get()\n  const accessToken = loggedInInstances[instanceName].access_token\n  try {\n    await doDeleteFilter(instanceName, accessToken, id)\n    /* no await */ toast.say(\"Deleted filter\")\n    emit('wordFiltersChanged', instanceName)\n  } catch (err) {\n    /* no await */ toast.say(formatIntl([\"Failed to modify filter: \",[\"error\"]], err.message || ''))\n  }\n}\n","import { get, DEFAULT_TIMEOUT, post, WRITE_TIMEOUT, put, del } from '../_utils/ajax.js'\nimport { auth, basename } from './utils.js'\n\nexport function getFilters (instanceName, accessToken) {\n  const url = `${basename(instanceName)}/api/v1/filters`\n  return get(url, auth(accessToken), { timeout: DEFAULT_TIMEOUT })\n}\n\nexport function createFilter (instanceName, accessToken, filter) {\n  const url = `${basename(instanceName)}/api/v1/filters`\n  return post(url, filter, auth(accessToken), { timeout: WRITE_TIMEOUT })\n}\n\nexport function updateFilter (instanceName, accessToken, filter) {\n  const url = `${basename(instanceName)}/api/v1/filters/${filter.id}`\n  return put(url, filter, auth(accessToken), { timeout: WRITE_TIMEOUT })\n}\n\nexport function deleteFilter (instanceName, accessToken, id) {\n  const url = `${basename(instanceName)}/api/v1/filters/${id}`\n  return del(url, auth(accessToken), { timeout: WRITE_TIMEOUT })\n}\n","import { auth, basename } from './utils.js'\nimport { post, put, get, del } from '../_utils/ajax.js'\n\nexport async function postSubscription (instanceName, accessToken, subscription, alerts) {\n  const url = `${basename(instanceName)}/api/v1/push/subscription`\n\n  return post(url, { subscription: subscription.toJSON(), data: { alerts } }, auth(accessToken))\n}\n\nexport async function putSubscription (instanceName, accessToken, alerts) {\n  const url = `${basename(instanceName)}/api/v1/push/subscription`\n\n  return put(url, { data: { alerts } }, auth(accessToken))\n}\n\nexport async function getSubscription (instanceName, accessToken) {\n  const url = `${basename(instanceName)}/api/v1/push/subscription`\n\n  return get(url, auth(accessToken))\n}\n\nexport async function deleteSubscription (instanceName, accessToken) {\n  const url = `${basename(instanceName)}/api/v1/push/subscription`\n\n  return del(url, auth(accessToken))\n}\n","const decodeBase64 = base64 => {\n  const rawData = window.atob(base64)\n  const outputArray = new Uint8Array(rawData.length)\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i)\n  }\n\n  return outputArray\n}\n\n// Taken from https://www.npmjs.com/package/web-push\nexport const urlBase64ToUint8Array = (base64String) => {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4)\n  const base64 = (base64String + padding)\n    .replace(/-/g, '+')\n    .replace(/_/g, '/')\n\n  return decodeBase64(base64)\n}\n","import { getSubscription, deleteSubscription, postSubscription, putSubscription } from '../_api/pushSubscription.js'\nimport { store } from '../_store/store.js'\nimport { urlBase64ToUint8Array } from '../_utils/base64.js'\n\nconst dummyApplicationServerKey = 'BImgAz4cF_yvNFp8uoBJCaGpCX4d0atNIFMHfBvAAXCyrnn9IMAFQ10DW_ZvBCzGeR4fZI5FnEi2JVcRE-L88jY='\n\nexport async function updatePushSubscriptionForInstance (instanceName) {\n  const { loggedInInstances, currentPushSubscription } = store.get()\n  const accessToken = loggedInInstances[instanceName].access_token\n\n  if (currentPushSubscription === null) {\n    return\n  }\n\n  const registration = await navigator.serviceWorker.ready\n  const subscription = await registration.pushManager.getSubscription()\n\n  if (subscription === null) {\n    store.setInstanceData(instanceName, 'pushSubscriptions', null)\n    store.save()\n    return\n  }\n\n  try {\n    const backendSubscription = await getSubscription(instanceName, accessToken)\n\n    // Check if applicationServerKey changed (need to get another subscription from the browser)\n    if (btoa(urlBase64ToUint8Array(backendSubscription.server_key).buffer) !== btoa(subscription.options.applicationServerKey)) {\n      await subscription.unsubscribe()\n      await deleteSubscription(instanceName, accessToken)\n      await updateAlerts(instanceName, currentPushSubscription.alerts)\n    } else {\n      store.setInstanceData(instanceName, 'pushSubscriptions', backendSubscription)\n      store.save()\n    }\n  } catch (e) {\n    // TODO: Better way to detect 404\n    if (e.message.startsWith('404:')) {\n      await subscription.unsubscribe()\n      store.setInstanceData(instanceName, 'pushSubscriptions', null)\n      store.save()\n    }\n  }\n}\n\nexport async function updateAlerts (instanceName, alerts) {\n  const { loggedInInstances } = store.get()\n  const accessToken = loggedInInstances[instanceName].access_token\n\n  const registration = await navigator.serviceWorker.ready\n  let subscription = await registration.pushManager.getSubscription()\n\n  if (subscription === null) {\n    // We need applicationServerKey in order to register a push subscription\n    // but the API doesn't expose it as a constant (as it should).\n    // So we need to register a subscription with a dummy applicationServerKey,\n    // send it to the backend saves it and return applicationServerKey, which\n    // we use to register a new subscription.\n    // https://github.com/tootsuite/mastodon/issues/8785\n    subscription = await registration.pushManager.subscribe({\n      applicationServerKey: urlBase64ToUint8Array(dummyApplicationServerKey),\n      userVisibleOnly: true\n    })\n\n    let backendSubscription = await postSubscription(instanceName, accessToken, subscription, alerts)\n\n    await subscription.unsubscribe()\n\n    subscription = await registration.pushManager.subscribe({\n      applicationServerKey: urlBase64ToUint8Array(backendSubscription.server_key),\n      userVisibleOnly: true\n    })\n\n    backendSubscription = await postSubscription(instanceName, accessToken, subscription, alerts)\n\n    store.setInstanceData(instanceName, 'pushSubscriptions', backendSubscription)\n    store.save()\n  } else {\n    try {\n      const backendSubscription = await putSubscription(instanceName, accessToken, alerts)\n      store.setInstanceData(instanceName, 'pushSubscriptions', backendSubscription)\n      store.save()\n    } catch (e) {\n      const backendSubscription = await postSubscription(instanceName, accessToken, subscription, alerts)\n      store.setInstanceData(instanceName, 'pushSubscriptions', backendSubscription)\n      store.save()\n    }\n  }\n}\n","export const HOME_REBLOGS = 'homeReblogs'\nexport const HOME_REPLIES = 'homeReplies'\n\nexport const NOTIFICATION_REBLOGS = 'notificationReblogs'\nexport const NOTIFICATION_FAVORITES = 'notificationFavs'\nexport const NOTIFICATION_FOLLOWS = 'notificationFollows'\nexport const NOTIFICATION_MENTIONS = 'notificationMentions'\nexport const NOTIFICATION_POLLS = 'notificationPolls'\nexport const NOTIFICATION_SUBSCRIPTIONS = 'notificationSubscriptions'\n"],"names":["async","syncFilters","instanceName","syncMethod","loggedInInstances","store","accessToken","access_token","url","timeout","getFilters","database","filters","instanceFilters","updateFiltersForInstance","setupFiltersForInstance","createOrUpdateFilter","filter","id","updateFilter","toast","createFilter","err","formatIntl","message","postSubscription","subscription","alerts","toJSON","data","urlBase64ToUint8Array","base64String","base64","rawData","window","atob","outputArray","Uint8Array","length","i","charCodeAt","decodeBase64","repeat","replace","updatePushSubscriptionForInstance","currentPushSubscription","registration","navigator","serviceWorker","ready","pushManager","getSubscription","backendSubscription","btoa","server_key","buffer","options","applicationServerKey","unsubscribe","deleteSubscription","updateAlerts","e","startsWith","subscribe","userVisibleOnly","putSubscription","HOME_REBLOGS","HOME_REPLIES","NOTIFICATION_REBLOGS","NOTIFICATION_FAVORITES","NOTIFICATION_FOLLOWS","NOTIFICATION_MENTIONS","NOTIFICATION_POLLS","NOTIFICATION_SUBSCRIPTIONS"],"sourceRoot":""}