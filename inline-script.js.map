{"version":3,"file":"inline-script.js","sources":["src/routes/_utils/themeEngine.js","src/routes/_utils/thunk.js","src/routes/_utils/testStorage.js","src/routes/_store/storeLite.js","src/routes/_utils/safeParse.js","src/routes/_utils/userAgent/isIOS.js","src/routes/_utils/userAgent/isIOSPre12Point2.js","src/routes/_utils/userAgent/isMac.js","src/inline-script/inline-script.js","src/routes/_api/utils.js","src/routes/_actions/onUserIsLoggedOut.js"],"sourcesContent":["const prefersDarkTheme = process.browser && matchMedia('(prefers-color-scheme: dark)').matches\nconst meta = process.browser && document.getElementById('theThemeColor')\n\nexport const INLINE_THEME = 'default' // theme that does not require external CSS\nexport const DEFAULT_LIGHT_THEME = 'default' // theme that is shown by default\nexport const DEFAULT_DARK_THEME = 'ozark' // theme that is shown for prefers-color-scheme:dark\nexport const DEFAULT_THEME = prefersDarkTheme ? DEFAULT_DARK_THEME : DEFAULT_LIGHT_THEME\n\nfunction getExistingThemeLink () {\n  return document.head.querySelector('link[rel=stylesheet][href^=\"/theme-\"]')\n}\n\nfunction resetExistingTheme () {\n  const existingLink = getExistingThemeLink()\n  if (existingLink) {\n    document.head.removeChild(existingLink)\n  }\n}\n\nfunction loadCSS (href) {\n  const existingLink = getExistingThemeLink()\n\n  const link = document.createElement('link')\n  link.rel = 'stylesheet'\n  link.href = href\n\n  link.addEventListener('load', function onload () {\n    link.removeEventListener('load', onload)\n    if (existingLink) { // remove after load to avoid flash of default theme\n      document.head.removeChild(existingLink)\n    }\n  })\n\n  document.head.appendChild(link)\n}\n\nexport function switchToTheme (themeName = DEFAULT_THEME, enableGrayscale) {\n  if (enableGrayscale) {\n    themeName = prefersDarkTheme ? 'dark-grayscale' : 'grayscale'\n  }\n  const themeColor = window.__themeColors[themeName]\n  meta.content = themeColor || window.__themeColors[DEFAULT_THEME]\n  if (themeName !== INLINE_THEME) {\n    loadCSS(`/theme-${themeName}.css`)\n  } else {\n    resetExistingTheme()\n  }\n}\n","// Run a function once, then cache the result and return the cached result thereafter\nexport function thunk (func) {\n  let cached\n  let runOnce\n  return () => {\n    if (!runOnce) {\n      cached = func()\n      runOnce = true\n    }\n    return cached\n  }\n}\n","// LocalStorage and IDB may be disabled in private mode, when \"blocking cookies\" in Safari,\n// or other cases\n\nimport { thunk } from './thunk.js'\n\nconst testKey = '__test__'\n\nexport const testHasLocalStorage = thunk(() => {\n  try {\n    localStorage.setItem(testKey, testKey)\n    if (!localStorage.length || localStorage.getItem(testKey) !== testKey) {\n      return false\n    }\n    localStorage.removeItem(testKey)\n  } catch (e) {\n    return false\n  }\n  return true\n})\n\nexport const testHasIndexedDB = thunk(async () => {\n  if (typeof indexedDB === 'undefined') {\n    return false\n  }\n\n  try {\n    const idbFailed = await new Promise(resolve => {\n      const db = indexedDB.open(testKey)\n      db.onerror = () => resolve(true)\n      db.onsuccess = () => {\n        indexedDB.deleteDatabase(testKey)\n        resolve(false)\n      }\n    })\n    if (idbFailed) {\n      return false\n    }\n  } catch (e) {\n    return false\n  }\n  return true\n})\n","// \"lite\" version of the store used in the inline script.\n\nimport { safeParse } from '../_utils/safeParse.js'\nimport { testHasLocalStorage } from '../_utils/testStorage.js'\n\nconst hasLocalStorage = testHasLocalStorage()\n\nexport const storeLite = {\n  get () {\n    return new Proxy({}, {\n      get: function (obj, prop) {\n        if (!(prop in obj)) {\n          obj[prop] = hasLocalStorage && safeParse(localStorage.getItem(`store_${prop}`))\n        }\n        return obj[prop]\n      }\n    })\n  },\n\n  set (obj) {\n    if (hasLocalStorage) {\n      for (const [key, value] of Object.entries(obj)) {\n        localStorage.setItem(`store_${key}`, JSON.stringify(value))\n      }\n    }\n  }\n}\n","export function safeParse (str) {\n  return !str ? undefined : (str === 'undefined' ? undefined : JSON.parse(str))\n}\n","import { thunk } from '../thunk.js'\n\nexport const isIOS = thunk(() => process.browser && /iP(?:hone|ad|od)/.test(navigator.userAgent))\n","// IntersectionObserver introduced in iOS 12.2 https://caniuse.com/#feat=intersectionobserver\nimport { thunk } from '../thunk.js'\nimport { isIOS } from './isIOS.js'\n\nexport const isIOSPre12Point2 = thunk(() => process.browser && isIOS() &&\n  !(typeof IntersectionObserver === 'function' &&\n    IntersectionObserver.toString().includes('[native code]')))\n","import { thunk } from '../thunk.js'\n\nexport const isMac = thunk(() => process.browser && /mac/i.test(navigator.platform))\n","\n// For perf reasons, this script is run inline to quickly set certain styles.\n// To allow CSP to work correctly, we also calculate a sha256 hash during\n// the build process and write it to checksum.js.\n\nimport { INLINE_THEME, DEFAULT_THEME, switchToTheme } from '../routes/_utils/themeEngine.js'\nimport { basename } from '../routes/_api/utils.js'\nimport { onUserIsLoggedOut } from '../routes/_actions/onUserIsLoggedOut.js'\nimport { storeLite } from '../routes/_store/storeLite.js'\nimport { isIOSPre12Point2 } from '../routes/_utils/userAgent/isIOSPre12Point2.js'\nimport { isMac } from '../routes/_utils/userAgent/isMac.js'\n\nwindow.__themeColors = process.env.THEME_COLORS\n\nconst {\n  currentInstance,\n  instanceThemes,\n  disableCustomScrollbars,\n  bottomNav,\n  enableGrayscale,\n  pushSubscription,\n  loggedInInstancesInOrder,\n  centerNav\n} = storeLite.get()\n\nconst theme = (instanceThemes && instanceThemes[currentInstance]) || DEFAULT_THEME\n\nif (currentInstance) {\n  // Do preconnect if we're logged in, so we can connect faster to the other origin.\n  const link = document.createElement('link')\n  link.setAttribute('rel', 'preconnect')\n  link.setAttribute('href', basename(currentInstance))\n  link.setAttribute('crossorigin', 'anonymous')\n  document.head.appendChild(link)\n}\n\nif (theme !== INLINE_THEME || enableGrayscale) {\n  // switch theme ASAP to minimize flash of default theme\n  switchToTheme(theme, enableGrayscale)\n}\n\nif (enableGrayscale) {\n  // set the grayscale style on every img, svg, etc.\n  document.getElementById('theGrayscaleStyle')\n    .setAttribute('media', 'all') // enables the style\n}\n\nif (!currentInstance) {\n  // if not logged in, show all these 'hidden-from-ssr' elements\n  onUserIsLoggedOut()\n}\n\nif (disableCustomScrollbars) {\n  document.getElementById('theScrollbarStyle')\n    .setAttribute('media', 'only x') // disables the style\n}\n\nif (bottomNav) {\n  document.getElementById('theBottomNavStyle')\n    .setAttribute('media', 'all') // enables the style\n}\n\nif (centerNav) {\n  document.getElementById('theCenterNavStyle')\n    .setAttribute('media', 'all') // enables the style\n}\n\n// hack to make the scrollbars rounded only on macOS\nif (isMac()) {\n  document.documentElement.style.setProperty('--scrollbar-border-radius', '50px')\n}\n\n// Versions of iOS Safari before iOS 12.2 do not work properly as a PWA\n// for cross-origin authentication: https://github.com/nolanlawson/pinafore/issues/45\n// Here we sniff for iOS <12.2 by checking for the existence of a native IntersectionObserver\n// function, which was added in 12.2.\nif (isIOSPre12Point2()) {\n  document.head.removeChild(document.getElementById('theManifest'))\n}\n\nif (pushSubscription) {\n  // Fix a bug in Pinafore <=v1.9.0 if we only have one instance we're logged in to\n  // (https://github.com/nolanlawson/pinafore/issues/1274)\n  if (loggedInInstancesInOrder && loggedInInstancesInOrder.length === 1) {\n    storeLite.set({\n      pushSubscriptions: {\n        [currentInstance]: pushSubscription\n      }\n    })\n  }\n  storeLite.set({\n    pushSubscription: null\n  })\n}\n","function targetIsLocalhost (instanceName) {\n  return instanceName.startsWith('localhost:') || instanceName.startsWith('127.0.0.1:')\n}\n\nexport function basename (instanceName) {\n  if (targetIsLocalhost(instanceName)) {\n    return `http://${instanceName}`\n  }\n  return `https://${instanceName}`\n}\n\nexport function auth (accessToken) {\n  return {\n    Authorization: `Bearer ${accessToken}`\n  }\n}\n","// When the user is logged out, we need to be sure to re-show all the \"hidden from SSR\" styles\n// so that we don't get a blank page.\nexport function onUserIsLoggedOut () {\n  if (document.getElementById('hiddenFromSsrStyle')) {\n    return\n  }\n  const style = document.createElement('style')\n  style.setAttribute('id', 'hiddenFromSsrStyle')\n  style.textContent = '.hidden-from-ssr { opacity: 1 !important; }'\n  document.head.appendChild(style)\n}\n"],"names":["prefersDarkTheme","matchMedia","matches","meta","document","getElementById","INLINE_THEME","DEFAULT_THEME","getExistingThemeLink","head","querySelector","thunk","func","cached","runOnce","testKey","hasLocalStorage","localStorage","setItem","length","getItem","removeItem","e","testHasLocalStorage","storeLite","get","Proxy","obj","prop","str","undefined","JSON","parse","set","key","value","Object","entries","stringify","isIOS","test","navigator","userAgent","isIOSPre12Point2","IntersectionObserver","toString","includes","isMac","platform","window","__themeColors","default","scarlet","seafoam","hotpants","oaken","majesty","gecko","grayscale","ozark","cobalt","sorcery","punk","riot","hacker","mastodon","pitchblack","currentInstance","instanceThemes","disableCustomScrollbars","bottomNav","enableGrayscale","pushSubscription","loggedInInstancesInOrder","centerNav","theme","link","createElement","setAttribute","instanceName","startsWith","targetIsLocalhost","appendChild","themeName","themeColor","content","href","existingLink","rel","addEventListener","onload","removeEventListener","removeChild","loadCSS","resetExistingTheme","switchToTheme","style","textContent","onUserIsLoggedOut","documentElement","setProperty","pushSubscriptions"],"mappings":"yBAAA,MAAMA,EAAsCC,WAAW,gCAAgCC,QACjFC,EAA0BC,SAASC,eAAe,iBAE3CC,EAAe,UAGfC,EAAgBP,EADK,QADC,UAInC,SAASQ,IACP,OAAOJ,SAASK,KAAKC,cAAc,wCACrC,CCTO,SAASC,EAAOC,GACrB,IAAIC,EACAC,EACJ,MAAO,KACAA,IACHD,EAASD,IACTE,GAAU,GAELD,EAEX,CCNA,MAAME,EAAU,WCAVC,EDE6BL,GAAM,KACvC,IAEE,GADAM,aAAaC,QAAQH,EAASA,IACzBE,aAAaE,QAAUF,aAAaG,QAAQL,KAAaA,EAC5D,OAAO,EAETE,aAAaI,WAAWN,EAGzB,CAFC,MAAOO,GACP,OAAO,CACR,CACD,OAAO,ICZeC,GAEXC,EAAY,CACvBC,IAAI,IACK,IAAIC,MAAM,GAAI,CACnBD,IAAK,SAAUE,EAAKC,GCVnB,IAAoBC,EDcnB,OAHMD,KAAQD,IACZA,EAAIC,GAAQZ,KCZKa,EDYwBZ,aAAaG,QAAQ,SAASQ,MCX5C,cAARC,OAAsBC,EAAYC,KAAKC,MAAMH,QAA1DC,IDaDH,EAAIC,EACZ,IAILK,IAAKN,GACH,GAAIX,EACF,IAAK,MAAOkB,EAAKC,KAAUC,OAAOC,QAAQV,GACxCV,aAAaC,QAAQ,SAASgB,IAAOH,KAAKO,UAAUH,GAGzD,GEvBUI,EAAQ5B,GAAM,IAAyB,mBAAmB6B,KAAKC,UAAUC,aCEzEC,EAAmBhC,GAAM,IAAyB4B,OAC3B,mBAAzBK,sBACPA,qBAAqBC,WAAWC,SAAS,oBCJhCC,EAAQpC,GAAM,IAAyB,OAAO6B,KAAKC,UAAUO,YCU1EC,OAAOC,cAAgB,CAAwBC,QAAA,UAAAC,QAAA,UAAAC,QAAA,UAAAC,SAAA,UAAAC,MAAA,cAAAC,QAAA,aAAAC,MAAA,UAAAC,UAAA,UAAAC,MAAA,UAAAC,OAAA,UAAAC,QAAA,UAAAC,KAAA,UAAAC,KAAA,UAAAC,OAAA,UAAAC,SAAA,UAAAC,WAAA,OAAA,iBAAA,QAE/C,MAAMC,gBACJA,EAAeC,eACfA,EAAcC,wBACdA,EAAuBC,UACvBA,EAASC,gBACTA,EAAeC,iBACfA,EAAgBC,yBAChBA,EAAwBC,UACxBA,GACElD,EAAUC,MAERkD,EAASP,GAAkBA,EAAeD,IAAqB5D,EAErE,GAAI4D,EAAiB,CAEnB,MAAMS,EAAOxE,SAASyE,cAAc,QACpCD,EAAKE,aAAa,MAAO,cACzBF,EAAKE,aAAa,OC/BpB,SAA4BC,GAC1B,OAAOA,EAAaC,WAAW,eAAiBD,EAAaC,WAAW,aAC1E,CAGMC,CADoBF,ED2BWZ,GCzB1B,UAAUY,IAEZ,WAAWA,KDwBlBH,EAAKE,aAAa,cAAe,aACjC1E,SAASK,KAAKyE,YAAYN,EAC5B,CC9BO,IAAmBG,GDgCtBJ,IAAUrE,GAAgBiE,IRAvB,SAAwBY,EAAY5E,EAAegE,GACpDA,IACFY,EAAYnF,EAAmB,iBAAmB,aAEpD,MAAMoF,EAAanC,OAAOC,cAAciC,GACxChF,EAAKkF,QAAUD,GAAcnC,OAAOC,cAAc3C,GAC9C4E,IAAc7E,EAvBpB,SAAkBgF,GAChB,MAAMC,EAAe/E,IAEfoE,EAAOxE,SAASyE,cAAc,QACpCD,EAAKY,IAAM,aACXZ,EAAKU,KAAOA,EAEZV,EAAKa,iBAAiB,QAAQ,SAASC,IACrCd,EAAKe,oBAAoB,OAAQD,GAC7BH,GACFnF,SAASK,KAAKmF,YAAYL,EAEhC,IAEEnF,SAASK,KAAKyE,YAAYN,EAC5B,CASIiB,CAAQ,UAAUV,SA/BtB,WACE,MAAMI,EAAe/E,IACjB+E,GACFnF,SAASK,KAAKmF,YAAYL,EAE9B,CA4BIO,EAEJ,CQTEC,CAAcpB,EAAOJ,GAGnBA,GAEFnE,SAASC,eAAe,qBACrByE,aAAa,QAAS,OAGtBX,GE7CE,WACL,GAAI/D,SAASC,eAAe,sBAC1B,OAEF,MAAM2F,EAAQ5F,SAASyE,cAAc,SACrCmB,EAAMlB,aAAa,KAAM,sBACzBkB,EAAMC,YAAc,8CACpB7F,SAASK,KAAKyE,YAAYc,EAC5B,CFuCEE,GAGE7B,GACFjE,SAASC,eAAe,qBACrByE,aAAa,QAAS,UAGvBR,GACFlE,SAASC,eAAe,qBACrByE,aAAa,QAAS,OAGvBJ,GACFtE,SAASC,eAAe,qBACrByE,aAAa,QAAS,OAIvB/B,KACF3C,SAAS+F,gBAAgBH,MAAMI,YAAY,4BAA6B,QAOtEzD,KACFvC,SAASK,KAAKmF,YAAYxF,SAASC,eAAe,gBAGhDmE,IAGEC,GAAgE,IAApCA,EAAyBtD,QACvDK,EAAUS,IAAI,CACZoE,kBAAmB,CACjBlC,CAACA,GAAkBK,KAIzBhD,EAAUS,IAAI,CACZuC,iBAAkB"}